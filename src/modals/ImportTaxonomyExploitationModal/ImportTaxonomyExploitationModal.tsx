import { Vue, Component, Prop, Ref } from 'vue-property-decorator';
import ImportValidation from 'components/ImportFile/ImportValidation';
import { handleError } from 'components/Toast';
import taxonomyExploitationModule from 'store/modules/taxonomy-exploitation';
import * as Styled from './styled';

@Component
export default class ImportTaxonomyExploitationModal extends Vue {
  @Prop({
    default: () => {
      //
    },
  })
  validateFile: (file: App.SelectedFile) => Promise<void>;
  @Prop({
    default: () => {
      //
    },
  })
  validatedFile: (data: Files.UploadedFileResponse) => void;
  @Prop({
    default: () => {
      //
    },
  })
  importTaxonomyExploitation: () => Promise<void>;
  @Ref('modal') readonly modalRef!: Vue;

  private isLoading: boolean = false;

  async onImportData(): Promise<void> {
    try {
      this.isLoading = true;
      if (this.importTaxonomyExploitation) {
        this.importTaxonomyExploitation();
      } else {
        this.$toast.success(this.$t('file_successfully_uploaded'));
      }
    } catch (error) {
      handleError(error as App.ResponseError);
    } finally {
      this.isLoading = false;
      this.closeModal();
    }
  }

  onResetUpload(): void {
    taxonomyExploitationModule.resetFileUpload();
    this.closeModal();
  }

  closeModal(): void {
    this.$emit('close');
  }

  render(): JSX.Element {
    return (
      <modal-layout showCloseIcon={false} title="" ref="modal">
        <Styled.Wrapper>
          <ImportValidation
            response={taxonomyExploitationModule.uploadedResponse}
            fileName={taxonomyExploitationModule.uploadedFile.name}
            validateFile={this.validateFile}
            validatedFile={this.validatedFile}
            uploadFile={this.onImportData}
            resetUpload={this.onResetUpload}
            addFile={this.closeModal}
            isLoading={this.isLoading}
            labelUpload="upload_validated_records"
            labelValidated={this.$t('indicator_list_has_been_validated')}
          />
        </Styled.Wrapper>
      </modal-layout>
    );
  }
}
